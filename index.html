<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jeux Kabir — Ultimate Pro</title>
<style>
:root{
  --bg1:#071129; --bg2:#10243a; --panel:rgba(255,255,255,0.04);
  --muted:#9fb0c6; --accent:#7cf5ff; --accent2:#8b5cf6; --gold:#f5c45b; --success:#2ecc71; --danger:#ff6b6b;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(160deg,var(--bg1),var(--bg2));color:#eaf6ff; -webkit-font-smoothing:antialiased}
.app{max-width:1100px;margin:18px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#06101a;font-weight:800;box-shadow:0 8px 30px rgba(6,16,26,.6)}
.title{font-size:18px;margin:0}
.subtitle{font-size:12px;color:var(--muted)}
.card{background:var(--panel);padding:16px;border-radius:14px;margin-top:14px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.menu{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
.menu button{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:12px;color:inherit;cursor:pointer;text-align:left}
.controls{display:flex;gap:8px;align-items:center}
.small{font-size:13px;color:var(--muted)}
.screen{display:none}
.screen.active{display:block}
.center{display:grid;place-items:center}
#gameWrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px}
#game{position:relative;width:100%;max-width:480px;height:240px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;overflow:hidden;box-shadow:inset 0 -40px 80px rgba(0,0,0,.3)}
.cupWrap{position:absolute;bottom:20px;width:90px;height:120px;transform-origin:center bottom;transition:transform .45s cubic-bezier(.2,.9,.2,1)}
.cup{width:100%;height:100%;border-radius:0 0 18px 18px;background:linear-gradient(180deg,#8b5a3b,#d6a57a);display:flex;align-items:end;justify-content:center;padding-bottom:12px;font-weight:800;color:#081018;box-shadow:0 8px 18px rgba(2,6,12,.6)}
.ball{position:absolute;width:26px;height:26px;border-radius:50%;background:var(--gold);bottom:110px;left:calc(50% - 13px);box-shadow:0 6px 18px rgba(246,196,91,.4);transition:transform .35s, left .35s}
.controlsRow{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:8px}
.btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#04121a;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted)}
.notice{font-weight:700;color:var(--muted);text-align:center;margin-top:6px}
.scoreRow{display:flex;gap:12px;justify-content:center;margin-top:6px;font-size:14px}
#simonWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
.padGrid{display:grid;grid-template-columns:repeat(2,120px);grid-template-rows:repeat(2,120px);gap:18px}
.pad{width:120px;height:120px;border-radius:14px;display:grid;place-items:center;cursor:pointer;box-shadow:0 12px 30px rgba(2,6,12,.6);transition:transform .12s,box-shadow .12s}
.pad.red{background:linear-gradient(180deg,#ff6b6b,#d94a4a)}
.pad.green{background:linear-gradient(180deg,#4ce07f,#2fa95b)}
.pad.blue{background:linear-gradient(180deg,#6fb4ff,#3f85ff)}
.pad.yellow{background:linear-gradient(180deg,#ffd77a,#ffb84a)}
.pad.active{transform:scale(1.06);box-shadow:0 20px 50px rgba(0,0,0,.6),0 0 40px rgba(255,255,255,.06)}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
@media(max-width:640px){
  .pad{width:92px;height:92px}
  .cupWrap{width:66px;height:88px}
  #game{height:200px}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo">K</div>
      <div>
        <div class="title">Jeux Kabir — Ultimate Pro</div>
        <div class="subtitle">Bonneteau & Simon — pro, responsive & musical</div>
      </div>
    </div>
    <div class="controls">
      <div class="small">Musique</div>
      <button id="toggleMusic" class="btn ghost">ON/OFF</button>
    </div>
  </div>

  <!-- intro -->
  <div id="intro" class="card screen active">
    <h2>Accès — Réponds aux questions</h2>
    <p class="small">Si tu donnes la bonne réponse à la première question, tu accèdes directement aux jeux. Sinon, tu auras une deuxième question.</p>
    <div style="margin-top:12px">
      <div id="qLabel" style="font-weight:800;margin-bottom:8px">Question 1/2</div>
      <div id="qText" class="notice">Qui est le meilleur ami de Kabir ?</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="qInput" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:inherit" placeholder="Ta réponse">
        <button id="qBtn" class="btn">Valider</button>
      </div>
      <div id="qMsg" class="small" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </div>

  <!-- menu -->
  <div id="menu" class="card screen">
    <h2>Menu principal</h2>
    <div class="menu">
      <button id="openBonneteau" class="menuBtn"><h3>🎩 Bonneteau (Pro)</h3><div class="small">Bille visible → mélange fluide → augmente le niveau</div></button>
      <button id="openSimon" class="menuBtn"><h3>🎨 Simon Musical</h3><div class="small">Chaque couleur = note. Crée des mélodies — monte en niveau</div></button>
    </div>
  </div>

  <!-- Bonneteau -->
  <div id="bonneteau" class="card screen">
    <h2>Bonneteau — niveau <span id="bnLevel">1</span></h2>
    <div id="gameWrap">
      <div id="game">
        <div id="ball" class="ball" style="display:block"></div>
        <!-- cupWraps -->
        <div id="cw0" class="cupWrap" style="left:calc(50% - 170px)"><div class="cup"> </div></div>
        <div id="cw1" class="cupWrap" style="left:calc(50% - 45px)"><div class="cup"></div></div>
        <div id="cw2" class="cupWrap" style="left:calc(50% + 80px)"><div class="cup"></div></div>
      </div>
      <div class="controlsRow">
        <button id="bnMix" class="btn">Mélanger</button>
        <button id="bnReset" class="btn ghost">Réinitialiser</button>
      </div>
      <div class="scoreRow"><div>Score : <strong id="bnScore">0</strong></div><div>Vitesse : <strong id="bnSpeed">normal</strong></div></div>
      <div id="bnMsg" class="notice">Regarde la bille, elle va se cacher puis les tasses vont bouger.</div>
      <div style="display:flex;justify-content:center;margin-top:8px"><button id="bnBack" class="btn ghost">Retour menu</button></div>
    </div>
  </div>

  <!-- Simon -->
  <div id="simon" class="card screen">
    <h2>Simon Musical — niveau <span id="smLevel">0</span></h2>
    <div id="simonWrap">
      <div class="padGrid">
        <div class="pad red" data-idx="0"></div>
        <div class="pad green" data-idx="1"></div>
        <div class="pad blue" data-idx="2"></div>
        <div class="pad yellow" data-idx="3"></div>
      </div>
      <div class="controlsRow">
        <button id="smStart" class="btn">Démarrer</button>
        <button id="smReset" class="btn ghost">Réinitialiser</button>
      </div>
      <div class="scoreRow"><div>Score : <strong id="smScore">0</strong></div><div>État : <strong id="smMsg">Prêt</strong></div></div>
      <div style="display:flex;justify-content:center;margin-top:8px"><button id="smBack" class="btn ghost">Retour menu</button></div>
    </div>
  </div>

  <div class="footer small">Développé avec soin • Compatible desktop / tablette / mobile</div>
</div>

<script>
/* ====== WebAudio setup (synth engine) ====== */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audio = new AudioCtx();
let bgGain = audio.createGain(); bgGain.gain.value = 0.18; bgGain.connect(audio.destination);
let masterGain = audio.createGain(); masterGain.gain.value = 0.9; masterGain.connect(bgGain);

/* small helper: ADSR synthed note (piano-ish) */
function playNote(freq, time=0, dur=0.6, type='sine'){
  const t = audio.currentTime + time;
  const osc = audio.createOscillator();
  const gain = audio.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, t);
  gain.gain.setValueAtTime(0.0001, t);
  gain.gain.exponentialRampToValueAtTime(1.0, t + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  const filter = audio.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value = Math.max(800, freq*6);
  osc.connect(filter); filter.connect(gain); gain.connect(masterGain);
  osc.start(t); osc.stop(t + dur + 0.02);
}

/* percussion (shuffle) */
function playShuffle() {
  const b = audio.createBufferSource();
  const rate = 2.2;
  // fake percussive click using noise burst
  const buffer = audio.createBuffer(1, audio.sampleRate * 0.12, audio.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++){
    data[i] = (Math.random()*2-1) * Math.exp(-i/1000);
  }
  b.buffer = buffer;
  const g = audio.createGain(); g.gain.value = 0.22;
  b.connect(g); g.connect(masterGain);
  b.start();
}

/* reveal sound */
function playReveal(){
  playNote(880, 0, 0.18, 'sine');
  playNote(1320, 0.05, 0.28, 'sine');
}

/* background pad (looping subtle) */
let bgOsc1, bgOsc2, bgRunning=false;
function startBackground(){
  if(bgRunning) return; bgRunning=true;
  bgOsc1 = audio.createOscillator(); bgOsc1.type='sine'; bgOsc1.frequency.value=120;
  const g1 = audio.createGain(); g1.gain.value=0.02;
  bgOsc1.connect(g1); g1.connect(bgGain);
  bgOsc2 = audio.createOscillator(); bgOsc2.type='sine'; bgOsc2.frequency.value=220;
  const g2 = audio.createGain(); g2.gain.value=0.015;
  bgOsc2.connect(g2); g2.connect(bgGain);
  bgOsc1.start(); bgOsc2.start();
}
function stopBackground(){
  if(!bgRunning) return; bgRunning=false;
  try{bgOsc1.stop(); bgOsc2.stop();}catch(e){}
}

/* unlock audio on user gesture */
function ensureAudioUnlocked(){
  if(audio.state==='suspended') audio.resume();
}

/* ====== UI logic ====== */
const screens = {intro:document.getElementById('intro'), menu:document.getElementById('menu'),
  bonneteau:document.getElementById('bonneteau'), simon:document.getElementById('simon')};
function showScreen(id){
  Object.values(screens).forEach(s=>s.classList.remove('active'));
  screens[id].classList.add('active');
}
document.getElementById('toggleMusic').addEventListener('click', ()=> {
  if(bgGain.gain.value>0.01){ bgGain.gain.value=0; document.getElementById('toggleMusic').textContent='OFF'; stopBackground(); }
  else { bgGain.gain.value=0.18; document.getElementById('toggleMusic').textContent='ON'; startBackground(); }
  ensureAudioUnlocked();
});

/* ====== Intro / Questions ====== */
const qA = {text:"Qui est le meilleur ami de Kabir ?", answer:"jesus"};
const qB = {text:"Quelle est la première amoureuse de Kabir ?", answer:"francoise"};
let qStep=0;
const qLabel = document.getElementById('qLabel'), qText=document.getElementById('qText'), qInput=document.getElementById('qInput'), qBtn=document.getElementById('qBtn'), qMsg=document.getElementById('qMsg');
function setQuestion(){
  qLabel.textContent = `Question ${qStep+1}/2`;
  qText.textContent = qStep===0? qA.text : qB.text;
  qInput.value=''; qMsg.textContent=''; qInput.focus();
}
qBtn.addEventListener('click', ()=>{ handleAnswer(qInput.value.trim().toLowerCase()); ensureAudioUnlocked(); });
qInput.addEventListener('keydown', e=>{ if(e.key==='Enter') { handleAnswer(qInput.value.trim().toLowerCase()); ensureAudioUnlocked(); }});
function handleAnswer(ans){
  if(qStep===0){
    if(ans===qA.answer){ showScreen('menu'); startBackground(); return; }
    else{ qStep=1; setQuestion(); return; }
  } else {
    if(ans===qB.answer){ showScreen('menu'); startBackground(); return; }
    else { qMsg.textContent = "Réponse incorrecte — tu peux réessayer ou accéder au menu."; /* allow retry */ }
  }
}
setQuestion();

/* ====== BONNETEAU (improved from your snippet) ====== */
const cw = [document.getElementById('cw0'), document.getElementById('cw1'), document.getElementById('cw2')];
const ballEl = document.getElementById('ball');
let bnLevel = 1, bnScore = 0, bnSpeed = 420, bnShuffling=false, bnBallPos=1;

function initBonneteau(){
  bnLevel = Number(document.getElementById('bnLevel').textContent) || 1;
  bnBallPos = Math.floor(Math.random()*3);
  // place cups original positions and show ball above the correct cup
  cw.forEach((c,i)=>{
    c.style.transition = 'transform .45s cubic-bezier(.2,.9,.2,1)';
    c.style.transform = 'translateX(0) rotateY(0deg) scale(1)';
  });
  placeBallOver(bnBallPos);
  document.getElementById('bnMsg').textContent = 'Regarde la bille, puis clique sur Mélanger';
  updateBnUI();
}

function placeBallOver(pos){
  const lefts = cw.map(c => c.offsetLeft + c.offsetWidth/2);
  // compute left relative to #game
  const gameRect = document.getElementById('game').getBoundingClientRect();
  const x = lefts[pos] - gameRect.left - 13;
  ballEl.style.left = `${x}px`; ballEl.style.display='block';
  ballEl.style.transform='scale(1)'; // visible
}

function hideBall(){
  ballEl.style.transform='scale(.3)'; // shrink while hidden
  setTimeout(()=>ballEl.style.display='none', 220);
}

function updateBnUI(){
  document.getElementById('bnLevel').textContent = bnLevel;
  document.getElementById('bnScore').textContent = bnScore;
  document.getElementById('bnSpeed').textContent = bnSpeed <= 150 ? 'rapide' : bnSpeed <= 300 ? 'normal' : 'lent';
}

document.getElementById('openBonneteau').addEventListener('click', ()=>{ showScreen('bonneteau'); initBonneteau(); ensureAudioUnlocked(); });

document.getElementById('bnBack').addEventListener('click', ()=>{ showScreen('menu'); });

function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

async function shuffleBonneteau(){
  if(bnShuffling) return;
  bnShuffling = true;
  ensureAudioUnlocked();
  document.getElementById('bnMsg').textContent = "Mélange en cours…";
  // hide ball visually
  hideBall();
  // number of swaps grows with level
  let swaps = Math.min(10 + bnLevel*2, 40);
  // shorter delay when level increases
  let delay = Math.max(120, bnSpeed - bnLevel*18);
  for(let s=0;s<swaps;s++){
    // pick two cups to swap positions
    const i = Math.floor(Math.random()*3);
    let j = Math.floor(Math.random()*3);
    while(j===i) j = Math.floor(Math.random()*3);
    // animate swap: we will swap their translateX offsets
    // compute simple X offsets for 3 positions: -170, 0, +170 (relative)
    // maintain logical order array
    playShuffle();
    await animateSwap(cw[i], cw[j], delay);
  }
  // after swaps, randomly reassign ball pos relative to visible cups
  // We'll map physical cups to indices: after swapping transforms, determine which cup is at which logical position by comparing offsetLeft
  // Simpler approach: randomly set new bnBallPos among 0..2 (player shouldn't know)
  bnBallPos = Math.floor(Math.random()*3);
  // reveal prompt
  document.getElementById('bnMsg').textContent = "Choisis un gobelet !";
  bnShuffling = false;
}

function playShuffle(){ playShuffleNoise(); } // alias

// per-swap animation: swap positions by swapping translateX values
function animateSwap(a,b,delay){
  return new Promise(res=>{
    // swap transforms
    const ta = a.style.transform || 'translateX(0) rotateY(0deg)';
    const tb = b.style.transform || 'translateX(0) rotateY(0deg)';
    // animate: rotate and slightly lift
    a.style.transition = `transform ${delay}ms cubic-bezier(.2,.9,.2,1)`;
    b.style.transition = `transform ${delay}ms cubic-bezier(.2,.9,.2,1)`;
    a.style.transform = tb + ` rotateX(18deg) translateY(-8px)`;
    b.style.transform = ta + ` rotateX(18deg) translateY(-8px)`;
    setTimeout(()=>{
      // settle back but swapped
      a.style.transform = tb.replace(' rotateX(18deg) translateY(-8px)','') + ` translateY(0) rotateY(${Math.random()*360}deg)`;
      b.style.transform = ta.replace(' rotateX(18deg) translateY(-8px)','') + ` translateY(0) rotateY(${Math.random()*360}deg)`;
      setTimeout(()=>res(), delay+40);
    }, delay);
  });
}

/* Use a simple noise burst as shuffle effect (percussive) */
function playShuffleNoise(){
  const dur=0.06;
  const bufferSize = audio.sampleRate * dur;
  const buffer = audio.createBuffer(1, bufferSize, audio.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++){
    data[i] = (Math.random()*2-1) * Math.exp(-i/ (bufferSize * 0.02));
  }
  const src = audio.createBufferSource(); src.buffer = buffer;
  const g = audio.createGain(); g.gain.value = 0.12;
  src.connect(g); g.connect(masterGain); src.start();
}

/* cup click handling */
async function onCupClick(e){
  if(bnShuffling) return;
  ensureAudioUnlocked();
  const clicked = Number(e.currentTarget.id.replace('cw',''));
  // determine which logical cup this is by comparing left positions relative to parent
  // For simplicity: compute nearest cup index based on center x within #game
  const gameRect = document.getElementById('game').getBoundingClientRect();
  const cx = e.clientX - gameRect.left;
  // compute center x of each cupWrap
  const centers = cw.map(c=> c.offsetLeft + c.offsetWidth/2 - gameRect.left);
  let chosenIdx = centers.reduce((best,val,i)=> Math.abs(val-cx) < Math.abs(centers[best]-cx) ? i : best ,0);
  // reveal: show ball above actual bnBallPos
  placeBallOver(bnBallPos);
  playReveal();
  if(chosenIdx === bnBallPos){
    document.getElementById('bnMsg').textContent = "🎉 Bravo ! Tu as trouvé la balle.";
    bnScore += 10;
    bnLevel += 1;
    // speed up
    bnSpeed = Math.max(140, bnSpeed - 28);
  } else {
    document.getElementById('bnMsg').textContent = "❌ Raté ! La balle était ailleurs.";
    bnScore = Math.max(0, bnScore - 5);
    // minor penalty and keep level but don't drop below 1
    bnLevel = Math.max(1, Math.floor(bnLevel/1.3));
    bnSpeed = 420;
  }
  updateBnUI();
  // brief pause then reposition ball for next round
  await sleep(900);
  initBonneteau();
}

/* attach cup handlers */
cw.forEach(c => c.addEventListener('click', onCupClick));
document.getElementById('bnMix').addEventListener('click', ()=> { shuffleBonneteau(); });
document.getElementById('bnReset').addEventListener('click', ()=> { bnLevel=1; bnScore=0; bnSpeed=420; updateBnUI(); initBonneteau(); });

/* ====== SIMON Musical (randomized melody) ====== */
/* define note frequencies (C major-ish palette) */
const notes = [ 523.25, 659.25, 783.99, 1046.50 ]; // C5, E5, G5, C6 roughly
const padEls = Array.from(document.querySelectorAll('.pad'));
let simonSeq = [], simonUser = [], simonLevel = 0, simonScore = 0, simonPlaying = false;

function initSimon(){ simonSeq = []; simonUser = []; simonLevel = 0; simonScore = 0; simonPlaying=false; document.getElementById('smLevel').textContent = simonLevel; document.getElementById('smScore').textContent = simonScore; document.getElementById('smMsg').textContent = 'Prêt'; }
document.getElementById('openSimon').addEventListener('click', ()=> { showScreen('simon'); initSimon(); ensureAudioUnlocked(); });
document.getElementById('smBack').addEventListener('click', ()=> showScreen('menu'));
document.getElementById('smStart').addEventListener('click', ()=> { if(!simonPlaying) nextSimonLevel(); });

padEls.forEach((pad, idx) => {
  pad.addEventListener('pointerdown', async (e) => {
    if(!simonPlaying && simonSeq.length===0) return; // not started
    if(!simonPlaying) return;
    highlightPad(idx);
    playNote(notes[idx], 0, 0.28, 'sine');
    simonUser.push(idx);
    checkSimonInput();
  });
});

/* show visual feedback */
function highlightPad(idx){
  const el = padEls[idx];
  el.classList.add('active');
  setTimeout(()=>el.classList.remove('active'), 260);
}

/* add next level and play sequence as melody */
async function nextSimonLevel(){
  simonPlaying = true;
  simonLevel += 1;
  simonSeq.push(Math.floor(Math.random()*4));
  document.getElementById('smLevel').textContent = simonLevel;
  document.getElementById('smMsg').textContent = 'Écoute la mélodie...';
  // play sequence with rising timing to feel musical
  for(let i=0;i<simonSeq.length;i++){
    const idx = simonSeq[i];
    highlightPad(idx);
    // slight harmonic layering for richness
    playNote(notes[idx], 0, 0.42, 'triangle');
    if(i < simonSeq.length-1) await sleep(460);
  }
  // let user play
  simonUser = [];
  document.getElementById('smMsg').textContent = 'À toi !';
  simonPlaying = true; // allow input
}

/* check user input */
function checkSimonInput(){
  const i = simonUser.length - 1;
  if(simonUser[i] !== simonSeq[i]){
    document.getElementById('smMsg').textContent = '❌ Raté — Recommence';
    simonSeq = []; simonUser = []; simonLevel = 0; simonScore = Math.max(0, simonScore - 1);
    document.getElementById('smScore').textContent = simonScore;
    simonPlaying = false;
    return;
  }
  if(simonUser.length === simonSeq.length){
    // success
    simonScore += simonSeq.length;
    document.getElementById('smScore').textContent = simonScore;
    document.getElementById('smMsg').textContent = '✅ Bien joué !';
    simonPlaying = false;
    setTimeout(()=> nextSimonLevel(), 700);
  }
}

/* initial inits */
initBonneteau();
initSimon();

/* unlock audio on first user action anywhere */
document.addEventListener('pointerdown', ()=> { ensureAudioUnlocked(); }, {once:true});
</script>
</body>
</html>
