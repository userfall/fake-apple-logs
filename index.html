<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kabir Virus Simulation — Demo</title>
<style>
  html,body{height:100%;margin:0;background:#000;color:#0f0;font-family: "Courier New", monospace;overflow:hidden}
  #container{position:relative;width:100%;height:100%;}
  canvas#matrix{position:absolute;left:0;top:0;width:100%;height:100%;z-index:0;opacity:0.6}
  .terminal{
    position: absolute;
    left:50%;top:50%;transform:translate(-50%,-50%);
    width:88%;max-width:1000px;height:60%;
    background:rgba(0,0,0,0.6); border:2px solid #060; box-shadow:0 10px 40px rgba(0,0,0,0.9);
    z-index:2; padding:18px; box-sizing:border-box; overflow:hidden;
    border-radius:8px;
  }
  .title{color:#6f6;font-weight:700;margin-bottom:8px}
  #log{height:82%;overflow:auto;white-space:pre-wrap; font-size:14px; line-height:1.3}
  .controls{position:absolute;right:18px;top:14px;display:flex;gap:8px}
  button{
    background:#062;border:1px solid #0a0;padding:8px 12px;border-radius:6px;color:#cfc;cursor:pointer;
    font-family:inherit;font-weight:600;
  }
  button.secondary{background:transparent;border:1px solid #044;color:#8f8}
  #camWrapper{position:absolute;right:20px;bottom:20px;z-index:3;background:rgba(0,0,0,0.45);padding:8px;border-radius:6px;display:none}
  video#cam{width:200px;height:150px;border-radius:6px;object-fit:cover;border:2px solid #072}
  .small{font-size:12px;color:#9f9}
</style>
</head>
<body>
<div id="container">
  <canvas id="matrix"></canvas>

  <div class="terminal" role="region" aria-label="Kabir simulation">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <span class="title">[KABIR-ATTACK-SIM]</span>
        <span class="small"> — simulation active</span>
      </div>
      <div class="controls">
        <button id="startBtn">Lancer</button>
        <button id="camBtn" class="secondary">Activer caméra</button>
        <button id="resetBtn" class="secondary">Réinitialiser</button>
      </div>
    </div>

    <div id="log" aria-live="polite"></div>
  </div>

  <div id="camWrapper">
    <div class="small">Caméra (permission requise)</div>
    <video id="cam" autoplay muted playsinline></video>
  </div>
</div>

<script>
/* ========== Matrix rain ========== */
const canvas = document.getElementById('matrix');
const ctx = canvas.getContext('2d');
let w, h, cols, size=16, drops;

function resize() {
  w = canvas.width = innerWidth;
  h = canvas.height = innerHeight;
  cols = Math.floor(w / size) + 1;
  drops = new Array(cols).fill(0).map(()=>Math.floor(Math.random()*h));
}
window.addEventListener('resize', resize);
resize();

function matrixLoop(){
  ctx.fillStyle = 'rgba(0,0,0,0.1)';
  ctx.fillRect(0,0,w,h);
  ctx.fillStyle = '#0f0';
  ctx.font = size + 'px monospace';
  for(let i=0;i<drops.length;i++){
    const text = String.fromCharCode(0x30A0 + Math.random()*96);
    ctx.fillText(text, i*size, drops[i]*size);
    if(drops[i]*size > h && Math.random()>0.975) drops[i]=0;
    drops[i]++;
  }
  requestAnimationFrame(matrixLoop);
}
matrixLoop();

/* ========== Terminal typing + fake commands ========== */
const log = document.getElementById('log');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const camBtn = document.getElementById('camBtn');
const camWrapper = document.getElementById('camWrapper');
const camVideo = document.getElementById('cam');

let sequence = [
  "Initialisation du moteur KABIR v3.14...",
  "Chargement des modules : [NET] [I/O] [CORE] [MATRIX_RENDERER] ...",
  "Connexion aux sockets locaux...",
  "Scanning des ports : 80, 443, 22, 3389 ...",
  "Injection de patterns visuels...",
  "Compilation dynamique des shaders...",
  "Simulation d'attaque en cours — ETA 00:00:23",
  "DETRUIRE: /usr/bin/FAKE_PROCESS",
  "ENVOI: paquets-> 127.0.0.1: flood (simulé)",
  "Analyse HACK_SUCCESS_RATE: 99.99% (simulé)",
  "RESULTAT: SYSTEME COMPROMIS (simulé) — affichage uniquement",
  "Terminé. Rendez-vous sur /dev/null"
];

let typing = null;
let idx=0;

function playBeepSequence(){
  // WebAudio dramatique
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  function beep(freq, time, dur, type='sine'){
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.value = freq;
    o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.0001, time);
    g.gain.exponentialRampToValueAtTime(0.05, time + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, time + dur);
    o.start(time); o.stop(time + dur + 0.02);
  }
  const now = ctx.currentTime + 0.02;
  beep(120, now, 0.18,'sawtooth');
  beep(240, now+0.12, 0.15,'sawtooth');
  beep(380, now+0.28, 0.22,'sine');
  beep(80, now+0.6, 0.6,'triangle');
}

/* slow type effect */
function typeLine(text, speed=35){
  return new Promise(res=>{
    let i=0;
    function step(){
      if(i<=text.length){
        log.innerText = log.innerText + text.charAt(i);
        log.scrollTop = log.scrollHeight;
        i++;
        setTimeout(step, speed + Math.random()*60);
      } else {
        log.innerText += "\n";
        log.scrollTop = log.scrollHeight;
        res();
      }
    }
    step();
  });
}

async function runSequence(){
  if(typing) return;
  typing = true;
  startBtn.textContent = "En cours...";
  startBtn.disabled = true;
  playBeepSequence();
  for(let s of sequence){
    // small pause to feel dramatic
    await typeLine("> " + s, 22);
    await new Promise(r=>setTimeout(r, 350 + Math.random()*420));
  }
  // extra dramatic block of "code"
  await typeLine("\n--- DUMP: memory @0xDEADBEEF ---", 12);
  for(let i=0;i<8;i++){
    await typeLine((Math.random().toString(16).substr(2,16) + "  " + Math.random().toString(2).substr(2,24)).slice(0,48), 6);
  }
  await typeLine("\nSimulation terminée. (Aucune action réelle effectuée)", 20);
  startBtn.textContent = "Lancer";
  startBtn.disabled = false;
  typing = false;
}

startBtn.addEventListener('click', ()=>{
  log.innerText = "";
  runSequence();
});

/* Reset */
resetBtn.addEventListener('click', ()=>{
  log.innerText = "";
});

/* ========== Camera (consentement explicite) ========== */
let stream = null;
camBtn.addEventListener('click', async ()=>{
  if(camWrapper.style.display === 'none' || camWrapper.style.display === ''){
    try{
      // Demande de permission : l'utilisateur verra la popup du navigateur.
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      camVideo.srcObject = stream;
      camWrapper.style.display = 'block';
      camBtn.textContent = "Désactiver caméra";
      // On applique un filtre "Matrix" basique via canvas capture if wanted (left simple)
    } catch(err){
      alert("Permission caméra refusée ou erreur: " + err.message);
    }
  } else {
    // stop stream
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    camVideo.srcObject = null;
    camWrapper.style.display = 'none';
    camBtn.textContent = "Activer caméra";
  }
});

/* Accessibility: allow Enter to start */
document.addEventListener('keydown', (e)=>{ if(e.key==='Enter') startBtn.click(); });

/* Small autoplay-safety: play a muted click sound on first user interaction to unlock AudioContext on mobile */
window.addEventListener('pointerdown', ()=>{ if((AudioContext || webkitAudioContext) && !window._audioUnlocked){ try{ new (window.AudioContext||window.webkitAudioContext)(); } catch(e){} window._audioUnlocked=true; } }, {once:true});
</script>
</body>
</html>
