<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Neon Lane Runner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* ...styles identiques √† ton fichier, conserv√©s pour la mise en page... */
    :root{
      --accent:#2d9cdb;
      --accent2:#38ef7d;
      --bg1:#232526;
      --bg2:#414345;
      --card-bg: #0f1720;
      --glass: rgba(255,255,255,0.04);
      --text:#e6f7ff;
    }
    html, body {
      margin:0; padding:0; min-height:100vh;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      color:var(--text);
      height: 100%;
      width: 100%;
      overflow-x: hidden;
    }
    #loginDiv, #gameDiv, #leaderboardDiv, #settingsDiv, #helpDiv {
      position:fixed; inset:0;
      display:flex; justify-content:center; align-items:center;
      z-index: 10;
    }
    .login-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius: 14px;
      box-shadow: 0 12px 42px rgba(0,0,0,0.6);
      padding: 22px;
      width: 95%;
      max-width: 980px;
      display: flex;
      gap: 22px;
      align-items: center;
      border: 1px solid rgba(255,255,255,0.03);
      backdrop-filter: blur(6px);
    }
    .logo-block {
      flex: 0 0 260px;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      padding: 18px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(45,156,219,0.08), rgba(56,239,125,0.03));
      box-shadow: 0 6px 18px rgba(45,156,219,0.06);
    }
    .fb-logo {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 44px;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -1.5px;
      text-shadow: 0 4px 18px rgba(45,156,219,0.18);
    }
    .logo-sub { color: rgba(255,255,255,0.55); font-size:13px; text-align:center; }
    .login-form { flex:1; display:flex; flex-direction:column; gap:10px; padding-right:10px; }
    .login-form input {
      padding:14px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
      color:var(--text); outline:none; font-size:15px;
    }
    .form-row { display:flex; gap:10px; }
    .login-form .btn {
      padding:12px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700;
    }
    .primary { background: linear-gradient(90deg,var(--accent),var(--accent2)); color:#0b1220; box-shadow: 0 10px 30px rgba(45,156,219,0.08); }
    .secondary { background: linear-gradient(90deg,#43e97b,#38f9d7); color:#072022; }
    #loginMsg { min-height:20px; font-size:14px; color:#ff8a8a; text-align:center; }
    footer { color: rgba(255,255,255,0.45); font-size:12px; text-align:center; margin-top:6px; }
    #gameContainer { display:flex; flex-direction:column; align-items:center; gap:8px; width:100%; padding:12px; box-sizing:border-box; }
    #hud { color:var(--accent); font-size:18px; text-shadow:0 0 8px rgba(255,255,255,0.03); display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .hud-btn { padding:8px 12px; border-radius:8px; border:none; background:var(--accent); color:#fff; cursor:pointer; font-weight:700; }
    .hud-btn.warn { background:#e53935; }
    #gameCanvas {
      background: linear-gradient(180deg,#0b0b0c,#121214);
      border-radius: 14px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.7), 0 0 48px rgba(45,156,219,0.06) inset;
      display:block;
      width: calc(min(1200px, 98vw));
      height: calc(min(820px, 78vh));
      touch-action:none;
    }
    .mobile-controls { display:none; justify-content:center; gap:18px; margin-top:10px; }
    .mobile-btn { width:52px; height:52px; border-radius:50%; border:none; background:var(--accent); color:#fff; font-size:20px; }
    .leader-card { max-width:640px; width:92%; padding:18px; border-radius:12px; background:var(--card-bg); box-shadow:0 12px 40px rgba(0,0,0,0.6); }
    ol{ padding-left:18px; margin:8px 0; }
    li{ margin:6px 0; color:rgba(255,255,255,0.9); }
    .rank-current{ background: linear-gradient(90deg, rgba(45,156,219,0.12), rgba(56,239,125,0.06)); padding:6px 8px; border-radius:8px; }
    @media (max-width:800px){
      .login-card { flex-direction:column; padding:14px; max-width: 96vw; }
      .logo-block { width:100%; flex:unset; padding:10px; }
      .login-form { width:100%; }
      #gameCanvas { height: calc(min(520px, 62vh)); width: calc(min(980px, 98vw)); }
      .mobile-controls { display:flex; }
    }
  </style>
</head>
<body>

<!-- ===== Connexion / Inscription ===== -->
<div id="loginDiv">
  <div class="login-card">
    <div class="logo-block">
      <div class="fb-logo">Neon Lane</div>
      <div class="logo-sub">Runner ‚Äî by Kabir & Samuel</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.45);margin-top:8px;text-align:center">Connexion rapide ‚Äî pseudo uniquement</div>
    </div>
    <div class="login-form">
      <div style="display:flex; gap:10px; align-items:center;">
        <input id="pseudo" type="text" placeholder="Pseudo" style="flex:1;">
        <input id="password" type="password" placeholder="Mot de passe" style="width:220px;">
      </div>
      <div class="form-row">
        <button class="btn primary" onclick="login()">Connexion</button>
        <button class="btn secondary" onclick="signup()">Cr√©er un compte</button>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="font-size:13px;color:rgba(255,255,255,0.6);">Langue</label>
        <select id="langSelect" style="padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);color:var(--text);border:1px solid rgba(255,255,255,0.03)">
          <option value="fr">fran√ßais</option>
          <option value="en">english</option>
        </select>
        <label style="margin-left:auto; font-size:13px; color:rgba(255,255,255,0.6);">Son</label>
        <input type="checkbox" id="soundToggle" checked>
      </div>
      <div id="loginMsg"></div>
      <footer>¬© 2025 Kabir &amp; Samuel Deporno ‚Äî All rights reserved</footer>
    </div>
  </div>
</div>

<!-- ===== Jeu ===== -->
<div id="gameDiv" style="display:none;">
  <div id="gameContainer">
    <div id="hud">
      <div id="hudText">Score: 0 | Vies: 3 | Niveau: 1</div>
      <div style="display:flex; gap:8px;">
        <button class="hud-btn" onclick="pauseGame()" title="Pause">‚è∏Ô∏è</button>
        <button class="hud-btn" onclick="showLeaderboard()" title="Classement">üèÜ</button>
        <button class="hud-btn" onclick="openSettings()" title="Param√®tres">‚öôÔ∏è</button>
        <button class="hud-btn warn" onclick="logout()" title="D√©connexion">üö™</button>
      </div>
    </div>
    <canvas id="gameCanvas" width="900" height="600"></canvas>
    <div class="mobile-controls">
      <button class="mobile-btn" onclick="moveLeft()">‚¨ÖÔ∏è</button>
      <button class="mobile-btn" onclick="moveRight()">‚û°Ô∏è</button>
      <button class="mobile-btn" onclick="pauseGame()">‚è∏Ô∏è</button>
    </div>
    <footer>¬© 2025 Kabir &amp; Samuel Deporno ‚Äî All rights reserved</footer>
  </div>
</div>

<!-- ===== Leaderboard ===== -->
<div id="leaderboardDiv" style="display:none;">
  <div class="leader-card">
    <h2 style="margin:0 0 8px 0; color:var(--accent)">üèÜ Classement G√©n√©ral</h2>
    <div id="rankingBoard">Chargement...</div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn primary" onclick="fetchLeaderboard()">‚Üª Rafra√Æchir</button>
      <button class="btn" onclick="backToGame()">Retour au jeu</button>
    </div>
    <div id="myRank" style="margin-top:10px;color:rgba(255,255,255,0.85)"></div>
    <footer style="margin-top:14px">¬© 2025 Kabir &amp; Samuel Deporno ‚Äî All rights reserved</footer>
  </div>
</div>

<!-- ===== Param√®tres et Aide ===== -->
<div id="settingsDiv" style="display:none;">
  <div class="login-card" style="max-width:400px;">
    <h2 style="color:var(--accent); margin:0 0 8px 0">Param√®tres</h2>
    <label style="font-size:14px;">
      Langue :
      <select id="langSelect2">
        <option value="fr">Fran√ßais</option>
        <option value="en">English</option>
      </select>
    </label>
    <label style="margin-top:10px;">
      Son :
      <input type="checkbox" id="soundToggle2" checked>
    </label>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button class="btn primary" onclick="showHelp()">Aide</button>
      <button class="btn" onclick="closeSettings()">Fermer</button>
    </div>
  </div>
</div>
<div id="helpDiv" style="display:none;">
  <div class="login-card" style="max-width:420px;">
    <h2 style="color:var(--accent); margin:0 0 8px 0">Aide</h2>
    <div id="helpTextContent" style="color:rgba(255,255,255,0.9); font-size:14px">
      D√©placez le joueur avec les fl√®ches gauche/droite ou les boutons.<br>
      √âvitez les obstacles qui tombent et ramassez les pi√®ces pour gagner des points.<br>
      Le jeu augmente en difficult√© √† chaque niveau.
    </div>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button class="btn" onclick="closeHelp()">Fermer</button>
    </div>
  </div>
</div>

<!-- ===== Firebase (compat) ===== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbNweC0aD8f_OGvbvmBVNSKbaMP_A4khI",
  authDomain: "neonlanerunner.firebaseapp.com",
  databaseURL: "https://neonlanerunner-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "neonlanerunner",
  storageBucket: "neonlanerunner.appspot.com",
  messagingSenderId: "916907926117",
  appId: "1:916907926117:web:43f1d08ed90b864a985c8c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ============================
   UTILS: sanitize Firebase keys
   ============================ */
function sanitizeKey(s){
  if(!s) return "anon";
  return String(s).replace(/[.#$\[\]\/]/g, "_");
}

/* ============================
   SONS & MUSIQUE
   ============================ */
let sounds = {}, musicAudio = null, soundOn = true;
function loadSounds(){
  try {
    sounds.coin = new Audio("https://cdn.jsdelivr.net/gh/terkelg/coin-sounds/coin1.wav");
    sounds.hit  = new Audio("https://cdn.jsdelivr.net/gh/terkelg/coin-sounds/coin2.wav");
    musicAudio = new Audio("https://cdn.jsdelivr.net/gh/terkelg/coin-sounds/coin3.wav");
    musicAudio.loop = true; musicAudio.volume = 0.18;
  } catch(e){ console.warn("Sound load failed", e); }
}
function playSound(name){
  if(!soundOn || !sounds[name]) return;
  try{ sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); } catch(e){}
}
function playMusic(){ if(!soundOn || !musicAudio) return; try{ musicAudio.play().catch(()=>{}); }catch{} }
function stopMusic(){ if(musicAudio) musicAudio.pause(); }

document.addEventListener("DOMContentLoaded", ()=>{
  const soundToggle = document.getElementById("soundToggle");
  if(soundToggle){
    soundToggle.addEventListener("change", e => { soundOn = e.target.checked; if(soundOn) playMusic(); else stopMusic(); });
  }
  const soundToggle2 = document.getElementById("soundToggle2");
  if(soundToggle2){
    soundToggle2.checked = soundOn;
    soundToggle2.addEventListener("change", e => { soundOn = e.target.checked; document.getElementById("soundToggle").checked = soundOn; if(soundOn) playMusic(); else stopMusic(); });
  }
});

/* ============================
   AUTH: signup / login
   ============================ */
function signup(){
  const pseudo = document.getElementById("pseudo").value.trim();
  const password = document.getElementById("password").value;
  const loginMsg = document.getElementById("loginMsg");
  loginMsg.style.color = "#ff8a8a";
  if(!pseudo || !password){ loginMsg.innerText = "Pseudo & mot de passe requis."; return; }
  if(password.length < 6){ loginMsg.innerText = "Mot de passe: 6+ caract√®res."; return; }
  const email = sanitizeKey(pseudo) + "@game.local";
  auth.fetchSignInMethodsForEmail(email)
    .then(methods => {
      if(methods && methods.length>0){
        loginMsg.innerText = "Ce pseudo est d√©j√† utilis√©.";
      } else {
        auth.createUserWithEmailAndPassword(email, password)
          .then(()=>{ loginMsg.style.color = "#9fffb2"; loginMsg.innerText = "Inscription OK ‚Äî connecte-toi."; })
          .catch(e => { loginMsg.innerText = e.message || "Erreur inscription."; });
      }
    })
    .catch(e => { loginMsg.innerText = e.message || "Erreur serveur."; });
}
function login(){
  const pseudo = document.getElementById("pseudo").value.trim();
  const password = document.getElementById("password").value;
  const loginMsg = document.getElementById("loginMsg");
  loginMsg.style.color = "#ff8a8a";
  if(!pseudo || !password){ loginMsg.innerText = "Pseudo & mot de passe requis."; return; }
  const email = sanitizeKey(pseudo) + "@game.local";
  auth.signInWithEmailAndPassword(email, password)
    .then(()=>{ loginMsg.innerText = ""; startGame(pseudo); })
    .catch(e => {
      if(e.code === "auth/user-not-found") loginMsg.innerText = "Aucun compte pour ce pseudo.";
      else if(e.code === "auth/wrong-password") loginMsg.innerText = "Mot de passe incorrect.";
      else loginMsg.innerText = e.message || "Erreur connexion.";
    });
}
function logout(){
  auth.signOut().catch(()=>{});
  document.getElementById("gameDiv").style.display = "none";
  document.getElementById("loginDiv").style.display = "flex";
  stopMusic();
}

/* ============================
   LEADERBOARD: save + fetch top10 + rank
   ============================ */
function saveScore(pseudo, score){
  if(!pseudo) return;
  const key = sanitizeKey(pseudo);
  const ref = db.ref("leaderboard/" + key);
  const safeScore = Number(score) || 0;
  ref.once("value").then(snap => {
    const v = snap.val();
    if(!v || safeScore > (Number(v.score)||0)){
      ref.set({
        pseudo: pseudo,
        score: safeScore,
        country: v && v.country ? v.country : "??",
        level: window.level || 1,
        lang: window.lang || "fr",
        timestamp: Date.now()
      }).catch(e => console.warn("saveScore error", e));
    }
  }).catch(e => console.warn("saveScore read error", e));
}
function fetchLeaderboard(){
  const boardEl = document.getElementById("rankingBoard");
  boardEl.innerHTML = "Chargement...";
  db.ref("leaderboard").once("value")
    .then(snapshot => {
      const entries = [];
      snapshot.forEach(child => {
        const val = child.val();
        if(val && val.pseudo && val.score != null){
          entries.push({
            pseudo: val.pseudo,
            score: Number(val.score) || 0,
            country: val.country || '??',
            level: val.level || 1,
            lang: val.lang || 'fr',
            timestamp: val.timestamp || 0
          });
        }
      });
      entries.sort((a,b) => b.score - a.score || b.timestamp - a.timestamp);
      let html = "<ol>";
      for(let i=0;i<10;i++){
        if(entries[i]){
          const e = entries[i];
          const rankClass = (window.currentPseudo && sanitizeKey(window.currentPseudo).toLowerCase() === sanitizeKey(e.pseudo).toLowerCase()) ? 'rank-current' : '';
          html += `<li class="${rankClass}"><b>#${i+1}</b> ${escapeHtml(e.pseudo)} (${escapeHtml(e.country)}) : <b>${e.score}</b> pts | Niv ${e.level}</li>`;
        } else {
          html += `<li style="color:#9aa2a8">${window.lang === 'fr' ? 'Vide' : 'Empty'}</li>`;
        }
      }
      html += "</ol>";
      boardEl.innerHTML = html;
      if(window.currentPseudo){
        const low = entries.map(x => sanitizeKey(x.pseudo).toLowerCase());
        const myKey = sanitizeKey(window.currentPseudo).toLowerCase();
        const idx = low.indexOf(myKey);
        const myRankEl = document.getElementById("myRank");
        if(idx >= 0){
          myRankEl.innerHTML = `Ton rang : <b>#${idx+1}</b> (sur ${entries.length}) ‚Äî score : <b>${entries[idx].score}</b>`;
        } else {
          const myScoreRef = db.ref("leaderboard/" + myKey);
          myScoreRef.once("value").then(snap => {
            const myVal = snap.val();
            if(myVal && myVal.score != null){
              const myScore = Number(myVal.score);
              let higher = entries.filter(x => x.score > myScore).length;
              document.getElementById("myRank").innerHTML = `Ton score : <b>${myScore}</b> ‚Äî rang approximatif : <b>#${higher+1}</b> (calcul local)`;
            } else {
              document.getElementById("myRank").innerText = "Tu n'as pas encore de score enregistr√©.";
            }
          });
        }
      } else {
        document.getElementById("myRank").innerText = "Connecte-toi pour voir ton rang.";
      }
    })
    .catch(err => {
      boardEl.innerHTML = `<span style="color:#ff8a8a">Erreur de chargement du classement.</span>`;
      console.error("fetchLeaderboard err", err);
    });
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}
function showLeaderboard(){
  document.getElementById("gameDiv").style.display = "none";
  document.getElementById("leaderboardDiv").style.display = "flex";
  fetchLeaderboard();
}
function backToGame(){
  document.getElementById("leaderboardDiv").style.display = "none";
  document.getElementById("gameDiv").style.display = "flex";
}

/* ============================
   JEU RUNNER
   ============================ */
let canvas, ctx;
let player, obstacles = [], coins = [];
let score = 0, lives = 3, gameSpeed = 3;
let keys = {}, gameInterval = null;
window.lang = 'fr';
window.level = 1;
let levelTimer = 0;

document.addEventListener("keydown", e => { keys[e.key] = true; });
document.addEventListener("keyup", e => { keys[e.key] = false; });

function handleTouchStart(e){
  if(!player) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.touches[0].clientX - rect.left;
  player.x = Math.max(0, Math.min(canvas.width - player.width, (x - player.width/2)));
}
function handleTouchMove(e){ handleTouchStart(e); }

document.addEventListener("DOMContentLoaded", ()=>{
  const canvasElem = document.getElementById("gameCanvas");
  canvasElem.addEventListener("touchstart", handleTouchStart, {passive:true});
  canvasElem.addEventListener("touchmove", handleTouchMove, {passive:true});
  document.getElementById("langSelect").addEventListener("change", e => { window.lang = e.target.value; });
  document.getElementById("langSelect2").addEventListener("change", e => { window.lang = e.target.value; document.getElementById("langSelect").value = e.target.value; });
});

function resizeCanvas() {
  if(!canvas) return;
  let maxW = Math.min(window.innerWidth * 0.98, 1200);
  let maxH = Math.min(window.innerHeight * 0.82, 880);
  const desiredRatio = 16/9;
  let w = maxW;
  let h = Math.round(Math.min(maxH, w / desiredRatio));
  if(window.innerWidth < 700) h = Math.min(maxH, Math.round(window.innerHeight * 0.62));
  canvas.width = Math.round(w);
  canvas.height = Math.round(h);
  if(player){
    player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
  }
}

function startGame(pseudo){
  document.getElementById("loginDiv").style.display = "none";
  document.getElementById("gameDiv").style.display = "flex";
  canvas = document.getElementById("gameCanvas");
  ctx = canvas.getContext("2d");
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);
  player = { x: canvas.width/2 - 20, y: canvas.height - 70, width:36, height:36, color:"#00ffff" };
  score = 0; lives = 3; gameSpeed = 3;
  obstacles = []; coins = [];
  window.level = 1; levelTimer = 0;
  if(gameInterval) clearInterval(gameInterval);
  gameInterval = setInterval(gameLoop, 16);
  loadSounds();
  playMusic();
  window.currentPseudo = pseudo;
  updateHUD();
}
function pauseGame(){
  if(gameInterval){ clearInterval(gameInterval); gameInterval = null; document.getElementById("hudText").innerText += " ¬∑ PAUSE"; stopMusic(); }
  else { gameInterval = setInterval(gameLoop, 16); playMusic(); }
}
function moveLeft(){ if(player) player.x -= Math.max(20, canvas.width * 0.06); }
function moveRight(){ if(player) player.x += Math.max(20, canvas.width * 0.06); }
function updateHUD(){
  document.getElementById("hudText").innerText =
    (window.lang === "fr")
      ? `Score: ${score} | Vies: ${lives} | Niveau: ${window.level}`
      : `Score: ${score} | Lives: ${lives} | Level: ${window.level}`;
}
function gameLoop(){
  if(!ctx) return;
  ctx.fillStyle = "#06060a";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  drawNeonBackground(ctx, canvas);
  if(keys["ArrowLeft"] || keys["a"]) player.x -= Math.max(3, gameSpeed);
  if(keys["ArrowRight"] || keys["d"]) player.x += Math.max(3, gameSpeed);
  player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
  drawRoundedRect(ctx, player.x, player.y, player.width, player.height, 6, "#0ff", true);
  if(Math.random() < 0.028 + (window.level * 0.002)) {
    obstacles.push({ x: Math.random() * (canvas.width - 40), y: -40, width: 34, height: 34, col: "#ff2dff" });
  }
  obstacles.forEach((o, idx) => {
    o.y += gameSpeed + (window.level * 0.4);
    drawRoundedRect(ctx, o.x, o.y, o.width, o.height, 6, o.col);
    if(collide(player, o)){ lives--; playSound("hit"); obstacles.splice(idx,1); if(lives <= 0) endGame(); }
    if(o.y > canvas.height + 50) obstacles.splice(idx,1);
  });
  if(Math.random() < 0.014) {
    coins.push({ x: Math.random() * (canvas.width - 26), y: -30, width: 22, height: 22 });
  }
  coins.forEach((c, idx) => {
    c.y += gameSpeed;
    ctx.beginPath();
    ctx.arc(c.x + c.width/2, c.y + c.height/2, c.width/2, 0, Math.PI*2);
    ctx.fillStyle = "#ffd700";
    ctx.fill();
    ctx.closePath();
    if(collide(player, c)){ score += 12; playSound("coin"); coins.splice(idx,1); }
    if(c.y > canvas.height + 30) coins.splice(idx,1);
  });
  updateHUD();
  levelTimer++;
  if(levelTimer % 900 === 0){
    window.level++;
    gameSpeed += 0.9;
  }
}
function drawRoundedRect(ctx, x, y, w, h, r, color, fill=false){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  if(fill){
    ctx.fillStyle = color; ctx.fill();
    ctx.strokeStyle = color; ctx.globalAlpha = 0.18; ctx.lineWidth = 10; ctx.stroke(); ctx.globalAlpha = 1;
  } else {
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
  }
  ctx.closePath();
}
function drawNeonBackground(ctx, canvas){
  const step = Math.max(40, Math.round(canvas.width/12));
  ctx.save();
  ctx.globalAlpha = 0.08;
  for(let x = 0; x < canvas.width; x += step){
    ctx.fillStyle = "#00a6ff";
    ctx.fillRect(x, 0, 2, canvas.height);
  }
  for(let y = 0; y < canvas.height; y += step){
    ctx.fillStyle = "#00f0b3";
    ctx.fillRect(0, y, canvas.width, 2);
  }
  ctx.restore();
}
function collide(a,b){
  return a && b &&
    a.x < b.x + b.width &&
    a.x + a.width > b.x &&
    a.y < b.y + b.height &&
    a.y + a.height > b.y;
}
function endGame(){
  if(gameInterval) { clearInterval(gameInterval); gameInterval = null; }
  stopMusic();
  setTimeout(()=> {
    const msg = (window.lang === "fr") ? `Fin du jeu ! Score : ${score}` : `Game Over! Score: ${score}`;
    if(confirm(msg + "\n\nVoir le classement ? (OK)  Rejouer ? (Annuler)")) {
      showLeaderboard();
    } else {
      if(window.currentPseudo) startGame(window.currentPseudo);
      else { document.getElementById("gameDiv").style.display = "none"; document.getElementById("loginDiv").style.display = "flex"; }
    }
  }, 120);
  try { saveScore(window.currentPseudo || "anon", score); } catch(e){ console.warn("saveScore error", e); }
}
window.addEventListener("resize", () => { resizeCanvas(); });
document.addEventListener("DOMContentLoaded", ()=> {
  canvas = document.getElementById("gameCanvas");
  resizeCanvas();
  loadSounds();
});
function openSettings(){ document.getElementById("settingsDiv").style.display = "flex"; }
function closeSettings(){ document.getElementById("settingsDiv").style.display = "none"; }
function showHelp(){ document.getElementById("helpDiv").style.display = "flex"; }
function closeHelp(){ document.getElementById("helpDiv").style.display = "none"; }
</script>
</body>
