<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jeux Kabir — Bonneteau 2D & Simon Musical (Pro)</title>

<!-- Police pro -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0a0a0a;          /* fond global noir */
  --panel:#1c1c1c;       /* cartes gris foncé */
  --muted:#aaaaaa;        /* texte secondaire */
  --accent:#1e90ff;       /* boutons / accents bleu électrique */
  --accent-dark:#1565c0;  /* dégradé boutons */
  --gold:#f5c45b;         /* optionnel */
  --danger:#ff3b3b;       /* balles / erreurs */
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:"Inter",Segoe UI,Roboto,Arial,sans-serif;color:#ffffff;-webkit-font-smoothing:antialiased}
.app{max-width:980px;margin:14px auto;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,.5)}
.title{font-size:18px;margin:0}
.subtitle{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}

/* Card / screens */
.card{background:var(--panel);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.screen{display:none}
.screen.active{display:block}
.menuGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.5)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--muted);font-weight:600}
.small{font-size:13px;color:var(--muted)}

/* Layout for games */
.game-area{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
#bnStage{width:100%;max-width:460px;height:220px;position:relative;border-radius:12px;background:linear-gradient(180deg,#111111,#222222);box-shadow:inset 0 -30px 60px rgba(255,255,255,.05);overflow:hidden}
.cup{position:absolute;bottom:18px;width:82px;height:82px;border-radius:50% 50% 0 0;background:linear-gradient(180deg,#333333,#555555);box-shadow:0 8px 20px rgba(0,0,0,.7);display:flex;align-items:flex-end;justify-content:center;padding-bottom:0;color:#fff;font-weight:800;cursor:pointer;touch-action:manipulation}
.ball{position:absolute;width:26px;height:26px;border-radius:50%;background:var(--danger);bottom:110px;left:50%;transform:translateX(-50%);box-shadow:0 6px 18px rgba(255,60,60,.5);transition:transform .18s}

/* controls row */
.controls-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px}
.scorebar{display:flex;gap:14px;justify-content:center;color:var(--muted);font-weight:700}

/* Simon */
.pad-grid{display:grid;grid-template-columns:repeat(2,120px);grid-gap:16px}
.pad{width:120px;height:120px;border-radius:12px;display:grid;place-items:center;cursor:pointer;box-shadow:0 12px 30px rgba(0,0,0,.5);transition:transform .12s,filter .12s}
.pad.red{background:linear-gradient(180deg,#ff5b5b,#c12b2b)}
.pad.green{background:linear-gradient(180deg,#5bff88,#2bc15b)}
.pad.blue{background:linear-gradient(180deg,#5bbfff,#2b7bc1)}
.pad.yellow{background:linear-gradient(180deg,#ffe55b,#c1aa2b)}
.pad.active{transform:scale(1.06);filter:brightness(1.12)}

/* Responsive tweaks */
@media(max-width:600px){
  .pad{width:84px;height:84px}
  #bnStage{height:180px}
  .cup{width:66px;height:66px}
  .ball{width:20px;height:20px;bottom:88px}
  .btn{padding:10px 12px}
}

/* tiny helper */
.center{display:grid;place-items:center}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo">K</div>
      <div>
        <div class="title">Jeux Kabir — Ultimate</div>
        <div class="subtitle">Bonneteau 2D & Simon Musical — responsive</div>
      </div>
    </div>
    <div class="controls">
      <button id="toggleAmb" class="btn ghost">Musique ON/OFF</button>
    </div>
  </div>

  <!-- INTRO / Q -->
  <div id="intro" class="card screen active">
    <h3 style="margin:6px 0 8px 0">Accès — Réponds aux questions</h3>
    <p class="small">Si la première réponse est correcte → accès direct. Sinon, on te propose la deuxième question.</p>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <div style="font-weight:800" id="qLabel">Question 1/2</div>
      <div style="flex:1" id="qText">Qui est le meilleur ami de Kabir ?</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="qInput" placeholder="Ta réponse" style="flex:1;padding:10px;border-radius:8px;border:1px solid #333;background:#111;color:#fff">
      <button id="qBtn" class="btn">Valider</button>
    </div>
    <div id="qMsg" class="small" style="margin-top:8px;color:var(--muted)"></div>
  </div>

  <!-- MENU -->
  <div id="menu" class="card screen">
    <h3 style="margin:6px 0 8px 0">Menu principal</h3>
    <div class="menuGrid">
      <button id="openBon" class="btn">🎩 Bonneteau 2D <div style="font-size:12px;color:var(--muted);font-weight:600">Bille visible → mélange fluide → niveaux</div></button>
      <button id="openSim" class="btn">🎵 Simon Musical <div style="font-size:12px;color:var(--muted);font-weight:600">Chaque couleur = note • séquences aléatoires</div></button>
    </div>
  </div>

  <!-- BONNETEAU 2D -->
  <div id="bon" class="card screen">
    <h3 style="margin:6px 0 8px 0">Bonneteau — niveau <span id="bnLevel">1</span></h3>
    <div class="game-area">
      <div id="bnStage" aria-label="Zone bonneteau">
        <div id="cup0" class="cup" data-index="0" style="left:40px"></div>
        <div id="cup1" class="cup" data-index="1" style="left:170px"></div>
        <div id="cup2" class="cup" data-index="2" style="left:300px"></div>
        <div id="ball" class="ball" aria-hidden="false"></div>
      </div>

      <div class="controls-row">
        <button id="mixBtn" class="btn">Mélanger</button>
        <button id="resetBn" class="btn ghost">Réinitialiser</button>
        <button id="backMenuBn" class="btn ghost">Retour</button>
      </div>

      <div class="scorebar">
        <div>Score : <span id="bnScore">0</span></div>
        <div>Vitesse : <span id="bnSpeed">normal</span></div>
      </div>
      <div id="bnMsg" class="small" style="margin-top:6px">Regarde la balle, puis clique sur Mélanger.</div>
    </div>
  </div>

  <!-- SIMON -->
  <div id="sim" class="card screen">
    <h3 style="margin:6px 0 8px 0">Simon Musical — niveau <span id="smLevel">0</span></h3>
    <div class="game-area">
      <div class="pad-grid center" style="width:100%;max-width:280px">
        <div class="pad red" data-idx="0"></div>
        <div class="pad green" data-idx="1"></div>
        <div class="pad blue" data-idx="2"></div>
        <div class="pad yellow" data-idx="3"></div>
      </div>

      <div class="controls-row">
        <button id="startSim" class="btn">Démarrer</button>
        <button id="resetSim" class="btn ghost">Réinitialiser</button>
        <button id="backMenuSim" class="btn ghost">Retour</button>
      </div>

      <div class="scorebar">
        <div>Score : <span id="smScore">0</span></div>
        <div>État : <span id="smMsg">Prêt</span></div>
      </div>
    </div>
  </div>

  <div style="text-align:center;margin-top:12px;color:var(--muted);font-size:13px">Développé — adapte / améliore à volonté</div>
</div>

<!-- Ici tu peux garder tout ton JS existant, il fonctionne sans modification majeure -->

<script>
// ... JS du jeu (Bonneteau + Simon + audio + navigation) ...
// Garde exactement le même JS que dans ton code initial, aucune modification nécessaire pour les couleurs


/* ================= WebAudio (no external files) ================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audio = new AudioCtx();
const master = audio.createGain(); master.gain.value = 0.9; master.connect(audio.destination);
const bgGain = audio.createGain(); bgGain.gain.value = 0.06; bgGain.connect(master);

function ensureAudio(){ if(audio.state === 'suspended') audio.resume(); }

/* note player */
function playNote(freq, when=0, dur=0.36, type='sine'){
  const t = audio.currentTime + when;
  const o = audio.createOscillator(); o.type = type; o.frequency.setValueAtTime(freq, t);
  const g = audio.createGain(); g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(1.0, t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  const f = audio.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = Math.max(800, freq*5);
  o.connect(f); f.connect(g); g.connect(master);
  o.start(t); o.stop(t + dur + 0.02);
}

/* short percussive click */
function clickSound(vol=0.12){
  const dur = 0.04;
  const buffer = audio.createBuffer(1, audio.sampleRate * dur, audio.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * Math.exp(-i/(data.length*0.02));
  const src = audio.createBufferSource(); src.buffer = buffer;
  const g = audio.createGain(); g.gain.value = vol; src.connect(g); g.connect(master); src.start();
}

/* ambient background */
let ambientOsc = null;
function startAmbient(){
  if(ambientOsc) return;
  const o1 = audio.createOscillator(); o1.type='sine'; o1.frequency.value = 110;
  const g1 = audio.createGain(); g1.gain.value = 0.02; o1.connect(g1); g1.connect(bgGain);
  const o2 = audio.createOscillator(); o2.type='sine'; o2.frequency.value = 220;
  const g2 = audio.createGain(); g2.gain.value = 0.01; o2.connect(g2); g2.connect(bgGain);
  o1.start(); o2.start();
  ambientOsc = [o1,o2];
}
function stopAmbient(){
  if(!ambientOsc) return;
  ambientOsc.forEach(o=>o.stop()); ambientOsc = null;
}

/* toggle ambient button */
document.getElementById('toggleAmb').addEventListener('click', ()=>{
  ensureAudio();
  if(bgGain.gain.value > 0.01){ bgGain.gain.value = 0; stopAmbient(); document.getElementById('toggleAmb').textContent='Musique ON/OFF'; }
  else { bgGain.gain.value = 0.06; startAmbient(); document.getElementById('toggleAmb').textContent='Musique ON/OFF'; }
});

/* unlock audio on first user action */
document.addEventListener('pointerdown', ()=> ensureAudio(), {once:true});

/* ================= Navigation & Q logic ================= */
const screens = { intro: document.getElementById('intro'), menu: document.getElementById('menu'),
  bon: document.getElementById('bon'), sim: document.getElementById('sim') };
function show(id){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[id].classList.add('active'); }

const qA = {text:"Qui est le meilleur ami de Kabir ?", answer:"jesus"};
const qB = {text:"Quelle est la première amoureuse de Kabir ?", answer:"francoise"};
let qStep = 0;
const qLabel = document.getElementById('qLabel'), qText = document.getElementById('qText'), qInput = document.getElementById('qInput'), qBtn = document.getElementById('qBtn'), qMsg = document.getElementById('qMsg');
function setQuestion(){ qLabel.textContent = `Question ${qStep+1}/2`; qText.textContent = qStep===0? qA.text : qB.text; qInput.value=''; qMsg.textContent=''; qInput.focus(); }
qBtn.addEventListener('click', ()=> handleAns(qInput.value.trim().toLowerCase()));
qInput.addEventListener('keydown', e=> { if(e.key==='Enter') handleAns(qInput.value.trim().toLowerCase()); });

function handleAns(ans){
  ensureAudio();
  if(qStep===0){
    if(ans === qA.answer){ show('menu'); startAmbient(); return; }
    else { qStep = 1; setQuestion(); return; }
  } else {
    if(ans === qB.answer){ show('menu'); startAmbient(); return; }
    else { qMsg.textContent = "Réponse incorrecte — réessaie."; return; }
  }
}
setQuestion();

/* ================= BONNETEAU 2D (smooth animation) ================= */
/* We'll animate cup positions with requestAnimationFrame using easing for perfect fluidity. */
const bnStage = document.getElementById('bnStage');
const cups = [document.getElementById('cup0'), document.getElementById('cup1'), document.getElementById('cup2')];
const ball = document.getElementById('ball');
const mixBtn = document.getElementById('mixBtn');
const resetBn = document.getElementById('resetBn');
const backMenuBn = document.getElementById('backMenuBn');
const bnMsg = document.getElementById('bnMsg');
const bnScoreEl = document.getElementById('bnScore');
const bnLevelEl = document.getElementById('bnLevel');
const bnSpeedEl = document.getElementById('bnSpeed');

let bnState = {
  positions: [],      // numeric x for left (px) relative to bnStage
  targetPositions: [],
  animating: false,
  ballIndex: 1,
  level: 1,
  score: 0,
  baseDelay: 420
};

/* Calculate base positions depending on stage width (responsive) */
function calcPositions(){
  const w = bnStage.clientWidth;
  // three positions spread horizontally with margins
  const left = Math.round(w*0.12);
  const mid = Math.round(w*0.5 - 41); // cup width ~82
  const right = Math.round(w*0.88 - 82);
  return [left, mid, right];
}

/* Set DOM cup left according to bnState.positions */
function applyPositions(){
  cups.forEach((c,i)=>{
    c.style.left = bnState.positions[i] + 'px';
  });
}

/* Place ball over index */
function placeBall(index){
  const rect = bnStage.getBoundingClientRect();
  const centers = bnState.positions.map(x => x + 41); // center of cup (82/2)
  const left = centers[index] - 13; // ball width 26/2 offset
  ball.style.left = left + 'px';
  ball.style.display = 'block';
  ball.style.transform = 'scale(1)';
  ball.setAttribute('aria-hidden','false');
}

/* Hide ball animation */
function hideBall(){
  ball.style.transform = 'scale(.3)';
  setTimeout(()=> ball.style.display='none', 200);
  ball.setAttribute('aria-hidden','true');
}

/* init */
function initBonneteau(){
  const pos = calcPositions();
  bnState.positions = pos.slice(); bnState.targetPositions = pos.slice();
  bnState.ballIndex = Math.floor(Math.random()*3);
  bnState.level = Math.max(1, bnState.level || 1);
  bnState.score = bnState.score || 0;
  bnState.baseDelay = 420;
  applyPositions();
  placeBall(bnState.ballIndex);
  updateBnUI();
  bnMsg.textContent = "Regarde la balle, puis clique sur Mélanger.";
}
function updateBnUI(){
  bnScoreEl.textContent = bnState.score;
  bnLevelEl.textContent = bnState.level;
  const speedText = bnState.baseDelay <= 160 ? 'rapide' : bnState.baseDelay <= 320 ? 'normal' : 'lent';
  bnSpeedEl.textContent = speedText;
}

/* Ease function */
function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }

/* animate swap between two indices with lift/arc -> returns Promise */
function animateSwap(i,j, duration){
  return new Promise(resolve=>{
    const startLeft = bnState.positions.slice();
    const endLeft = startLeft.slice();
    endLeft[i] = startLeft[j]; endLeft[j] = startLeft[i];
    const start = performance.now();
    const lift = 28; // px lift effect
    function frame(now){
      const elapsed = now - start;
      const t = Math.min(1, elapsed/duration);
      const e = easeInOutCubic(t);
      // interpolate positions
      for(let k=0;k<3;k++){
        const sx = startLeft[k], ex = endLeft[k];
        const cur = sx + (ex - sx) * e;
        bnState.positions[k] = cur;
        // set transforms for lifted cups:
        if(k===i || k===j){
          // for visual lift add transform translateY and rotate
          const liftPhase = Math.sin(e*Math.PI); // 0->1->0
          const translateY = -lift * liftPhase;
          const rotate = (k===i ? 8 : -8) * liftPhase;
          cups[k].style.transform = `translateY(${translateY}px) rotate(${rotate}deg)`;
        } else {
          cups[k].style.transform = 'translateY(0px) rotate(0deg)';
        }
      }
      applyPositions();
      if(t<1) requestAnimationFrame(frame);
      else {
        // reset transforms
        cups.forEach(c=> c.style.transform = 'translateY(0px) rotate(0deg)');
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

/* Shuffle routine: multiple random swaps with dynamic timing */
async function shuffleRoutine(){
  if(bnState.animating) return;
  bnState.animating = true;
  ensureAudio();
  bnMsg.textContent = "Mélange en cours…";
  hideBall();
  // number of swaps grows with level
  let swaps = Math.min(8 + bnState.level * 2, 40);
  const minDur = 90;
  for(let s=0;s<swaps;s++){
    const i = Math.floor(Math.random()*3);
    let j = Math.floor(Math.random()*3);
    while(j===i) j = Math.floor(Math.random()*3);
    // duration reduces with level
    const base = Math.max(minDur, bnState.baseDelay - bnState.level*18);
    const dur = base + Math.random()*60;
    // play little click sound
    clickSound(0.08);
    await animateSwap(i,j, dur);
  }
  // after shuffles, pick a new hidden position so it's not trivially traceable
  bnState.ballIndex = Math.floor(Math.random()*3);
  bnMsg.textContent = "Clique sur un gobelet !";
  bnState.animating = false;
}

/* Cup click handler: detect nearest cup center and evaluate */
function onCupClick(e){
  if(bnState.animating) return;
  ensureAudio();
  // get click pos relative to stage
  const rect = bnStage.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const centers = bnState.positions.map(p => p + 41);
  let chosen = centers.reduce((best,cur,i)=> Math.abs(cur-x) < Math.abs(centers[best]-x) ? i : best, 0);
  // reveal ball
  placeBall(bnState.ballIndex);
  // reveal sound
  playNote(880,0,0.12,'sine'); playNote(1320,0.06,0.18,'sine');
  if(chosen === bnState.ballIndex){
    bnMsg.textContent = "🎉 Bravo !";
    bnState.score += 10;
    bnState.level += 1;
    bnState.baseDelay = Math.max(120, bnState.baseDelay - 28);
    // fun success stinger
    playNote(1046, 0.02, 0.16, 'triangle');
    playNote(1318, 0.18, 0.22, 'sine');
  } else {
    bnMsg.textContent = "❌ Raté !";
    bnState.score = Math.max(0, bnState.score - 5);
    bnState.level = Math.max(1, Math.floor(bnState.level/1.3));
    bnState.baseDelay = 420;
    // sad sound
    playNote(220, 0.02, 0.28, 'sine');
  }
  updateBnUI();
  // small pause then reset for next round
  setTimeout(()=> initBonneteau(), 900);
}

cups.forEach(c => {
  c.addEventListener('pointerdown', onCupClick);
  c.addEventListener('touchstart', onCupClick);
});

/* Hook buttons */
mixBtn.addEventListener('click', ()=> { shuffleRoutine(); ensureAudio(); });
resetBn.addEventListener('click', ()=> { bnState.level = 1; bnState.score = 0; bnState.baseDelay = 420; initBonneteau(); });
backMenuBn.addEventListener('click', ()=> { show('menu'); });

/* ================= Simon Musical ================= */
const padEls = Array.from(document.querySelectorAll('.pad'));
const padFreq = [523.25, 659.25, 783.99, 1046.50]; // C5 E5 G5 C6
let simState = { seq: [], user: [], level:0, score:0, playing:false };

function initSimon(){
  simState.seq = []; simState.user = []; simState.level = 0; simState.score = 0; simState.playing = false;
  document.getElementById('smLevel').textContent = simState.level;
  document.getElementById('smScore').textContent = simState.score;
  document.getElementById('smMsg').textContent = 'Prêt';
}
function highlightPad(i){
  padEls[i].classList.add('active');
  setTimeout(()=> padEls[i].classList.remove('active'), 260);
}
async function playSequence(){
  simState.playing = false;
  document.getElementById('smMsg').textContent = 'Écoute...';
  for(let i=0;i<simState.seq.length;i++){
    const p = simState.seq[i];
    highlightPad(p);
    playNote(padFreq[p], 0, 0.36, 'sine');
    // slight layer for richness
    if(i % 2 === 0) playNote(padFreq[p]*2, 0.02, 0.28, 'triangle');
    await new Promise(r=>setTimeout(r, 520));
  }
  simState.user = [];
  simState.playing = true;
  document.getElementById('smMsg').textContent = 'À toi !';
}

function nextSimonLevel(){
  simState.level++;
  document.getElementById('smLevel').textContent = simState.level;
  simState.seq.push(Math.floor(Math.random()*4));
  playSequence();
}

padEls.forEach((pad, idx) => {
  // pointer events for mobile + mouse
  pad.addEventListener('pointerdown', ()=>{
    if(!simState.playing) return;
    ensureAudio();
    highlightPad(idx);
    playNote(padFreq[idx], 0, 0.36, 'triangle');
    simState.user.push(idx);
    checkSimon();
  });
});

function checkSimon(){
  const i = simState.user.length - 1;
  if(simState.user[i] !== simState.seq[i]){
    document.getElementById('smMsg').textContent = '❌ Mauvaise séquence !';
    simState.playing = false;
    simState.seq = []; simState.user = []; simState.level = 0;
    simState.score = Math.max(0, simState.score - 1);
    document.getElementById('smScore').textContent = simState.score;
    return;
  }
  if(simState.user.length === simState.seq.length){
    // success
    simState.score += simState.seq.length;
    document.getElementById('smScore').textContent = simState.score;
    document.getElementById('smMsg').textContent = '✅ Bien joué !';
    simState.playing = false;
    setTimeout(()=> nextSimonLevel(), 700);
  }
}

/* Simon controls */
document.getElementById('startSim').addEventListener('click', ()=>{
  ensureAudio();
  if(!simState.playing && simState.seq.length===0) nextSimonLevel();
});
document.getElementById('resetSim').addEventListener('click', ()=> initSimon());
document.getElementById('backMenuSim').addEventListener('click', ()=> show('menu'));

/* Menu openers */
document.getElementById('openBon').addEventListener('click', ()=> { show('bon'); initBonneteau(); ensureAudio(); });
document.getElementById('openSim').addEventListener('click', ()=> { show('sim'); initSimon(); ensureAudio(); });

/* init app */
show('intro');
initBonneteau();
initSimon();

/* handle window resize -> recalc positions so responsive */
let resizeTimer = null;
window.addEventListener('resize', ()=> {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=> {
    // recalc base positions and apply
    const newPos = calcPositions();
    bnState.positions = newPos.slice();
    applyPositions();
    placeBall(bnState.ballIndex);
  }, 120);
});
</script>
</body>
</html>

